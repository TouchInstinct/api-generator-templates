import LeadKit
import RxSwift
import Alamofire

{% set serviceName = concat(networkServiceName, "NetworkService") -%}
{% set protocolName = concat(networkServiceName, "NetworkProtocol") -%}

protocol {{ protocolName }} {

    func apiRequest<T: Decodable>(with parameters: ApiRequestParameters, decoder: JSONDecoder) -> Single<T>
    func apiRequestParameters(relativeUrl: String,
                              method: HTTPMethod,
                              parameters: Parameters?,
                              requestEncoding: ParameterEncoding?,
                              requestHeaders: HTTPHeaders?) -> ApiRequestParameters

    {% for method in methods %}
    {%- include 'blocks/method/method-declaration.twig' with { method: method, isStatic: false } %}
    {% endfor %}
}

class {{ serviceName }}: NetworkService, {{ protocolName }} {

    static let apiBaseUrl = "{{ apiUrl }}"

    convenience init() {
        self.init(configuration: NetworkServiceConfiguration(baseUrl: {{ serviceName }}.apiBaseUrl))
    }

    func apiRequest<T: Decodable>(with parameters: ApiRequestParameters, decoder: JSONDecoder = JSONDecoder()) -> Single<T> {
        return rxRequest(with: parameters, decoder: decoder).map { $0.model }.asSingle()
    }

    func apiRequestParameters(relativeUrl: String,
                              method: HTTPMethod = .get,
                              parameters: Parameters? = nil,
                              requestEncoding: ParameterEncoding? = nil,
                              requestHeaders: HTTPHeaders? = nil) -> ApiRequestParameters {
        return configuration.apiRequestParameters(relativeUrl: relativeUrl,
                                                  method: method,
                                                  parameters: parameters,
                                                  requestEncoding: requestEncoding,
                                                  requestHeaders: requestHeaders)
    }

}
{{ "\n" }}
