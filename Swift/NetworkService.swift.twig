import LeadKit
import RxSwift
import Alamofire

{% set serviceName = concat(networkServiceName, "NetworkService") -%}
{% set protocolName = concat(networkServiceName, "NetworkProtocol") -%}

protocol {{ protocolName }} {

    func apiRequest<T: Decodable>(with parameters: Single<ApiRequestParameters>, decoder: JSONDecoder) -> Single<T>
    func deferredApiRequestParameters(relativeUrl: String,
                              method: HTTPMethod,
                              parameters: Parameters?,
                              requestEncoding: ParameterEncoding?,
                              requestHeaders: HTTPHeaders?) -> Single<ApiRequestParameters>

    {% for method in methods %}
    {%- include 'blocks/method/method-declaration.twig' with { method: method, isStatic: false } -%}
    {% endfor %}
}

class {{ serviceName }}: NetworkService, {{ protocolName }} {

    static let apiBaseUrl = "{{ apiUrl }}"

    convenience init() {
        self.init(configuration: NetworkServiceConfiguration(baseUrl: {{ serviceName }}.apiBaseUrl))
    }

    func apiRequest<T: Decodable>(with parameters: Single<ApiRequestParameters>, decoder: JSONDecoder = JSONDecoder()) -> Single<T> {
        return parameters.flatMap { parameters -> Single<T> in
            self.rxRequest(with: parameters, decoder: decoder).map { $0.model }.asSingle()
        }
    }

    func deferredApiRequestParameters(relativeUrl: String,
                              method: HTTPMethod = .get,
                              parameters: Parameters? = nil,
                              requestEncoding: ParameterEncoding? = nil,
                              requestHeaders: HTTPHeaders? = nil) -> Single<ApiRequestParameters> {
        return .deferred({ () -> Single<ApiRequestParameters> in
            return .create(subscribe: { single -> Disposable in
                let parameters = self.configuration.apiRequestParameters(relativeUrl: relativeUrl,
                                                                    method: method,
                                                                    parameters: parameters,
                                                                    requestEncoding: requestEncoding,
                                                                    requestHeaders: requestHeaders)
                single(.success(parameters))
                return Disposables.create()
            })
        })
    }

}
{{ "\n" }}
